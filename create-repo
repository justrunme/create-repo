#!/bin/bash

# ðŸŒŸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸: GitHub CLI
if ! command -v gh &>/dev/null; then
  echo "ðŸ› ï¸ GitHub CLI (gh) Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼..."
  if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    type -p curl >/dev/null || sudo apt install curl -y
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
      sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
    sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | \
      sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    sudo apt update
    sudo apt install gh -y
  else
    echo "âŒ ÐÐ²Ñ‚Ð¾ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Linux (APT). Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ gh Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ: https://cli.github.com/"
    exit 1
  fi
fi

# ðŸ“‚ Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð¿Ð°Ð¿ÐºÐ°
current_dir=$(basename "$PWD")
echo "ðŸ“ Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð¿Ð°Ð¿ÐºÐ°: $current_dir"

# ðŸ“Œ Ð˜Ð¼Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
read -p "ðŸ”¤ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð½Ð° GitHub (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: $current_dir): " repo
repo=${repo:-$current_dir}

# ðŸ”“ ÐŸÑ€Ð¸Ð²Ð°Ñ‚Ð½Ð¾ÑÑ‚ÑŒ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹)
read -p "ðŸ” Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¼? (y/n, Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: n): " private
private=${private:-n}
visibility=$([[ "$private" == [Yy] ]] && echo "private" || echo "public")

# ðŸš€ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Git
if [ ! -d .git ]; then
  echo "ðŸš€ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Git..."
  git init
else
  echo "ðŸ” Git ÑƒÐ¶Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½."
fi

# ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° Ð²ÐµÑ‚ÐºÑƒ main, ÐµÑÐ»Ð¸ ÐµÑ‘ ÐµÑ‰Ñ‘ Ð½ÐµÑ‚
if ! git show-ref --quiet refs/heads/main; then
  git checkout -b main
else
  git checkout main
fi

# README.md
if [ ! -f README.md ]; then
  echo "# $repo" > README.md
  echo "ðŸ“„ README.md ÑÐ¾Ð·Ð´Ð°Ð½."
fi

# .gitignore â€” Ð°Ð²Ñ‚Ð¾Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ
if [ ! -f .gitignore ]; then
  echo "ðŸ¤– ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."

  if ls *.tf >/dev/null 2>&1 || [ -f main.tf ]; then
    template="terraform"
  elif [ -f package.json ]; then
    template="node"
  elif ls *.py >/dev/null 2>&1 || [ -f requirements.txt ] || [ -d .venv ]; then
    template="python"
  elif ls *.java >/dev/null 2>&1 || [ -f pom.xml ] || [ -f build.gradle ]; then
    template="java"
  else
    template="none"
  fi

  echo "ðŸ“‚ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ Ñ‚Ð¸Ð¿ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°: $template"

  case $template in
    python)
      cat <<EOF > .gitignore
__pycache__/
*.py[cod]
*.egg-info/
.env
.venv
EOF
      ;;
    node)
      cat <<EOF > .gitignore
node_modules/
dist/
.env
npm-debug.log
EOF
      ;;
    java)
      cat <<EOF > .gitignore
*.class
*.jar
*.war
*.log
target/
EOF
      ;;
    terraform)
      cat <<EOF > .gitignore
.terraform/
*.tfstate
*.tfstate.*
crash.log
*.backup
EOF
      ;;
    none)
      touch .gitignore
      ;;
  esac

  echo "âœ… .gitignore ÑÐ¾Ð·Ð´Ð°Ð½."
fi

# ðŸ“¦ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚
echo "ðŸ“¦ Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹..."
git add .

if git diff --cached --quiet; then
  echo "âš ï¸ ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°. ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚."
  skip_commit=true
else
  echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚..."
  git commit -m "Initial commit"
fi

# ðŸŒ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°, ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð½Ð° GitHub
if gh repo view "$repo" &>/dev/null; then
  echo "ðŸ” Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð½Ð° GitHub. ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ."
else
  echo "ðŸŒ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð½Ð° GitHub..."
  gh repo create "$repo" --source=. --"$visibility" --push
fi

# â¬†ï¸ Push, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹
if [ "$skip_commit" != true ]; then
  echo "â¬†ï¸ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² GitHub..."
  git push -u origin main
fi

# âœ… Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´
user=$(gh auth status --show-token 2>/dev/null | grep -oP '(?<=as ).*')
echo "âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: https://github.com/${user:-your-username}/$repo"
